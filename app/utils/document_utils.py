"""Utility functions for document processing."""
import os
from docx import Document


def classify_intent_and_structure(query: str) -> tuple[str, str]:
    """Определяет тип документа и возвращает его универсальную структуру."""
    query_lower = query.lower()
    
    if "техническое задание" in query_lower or "тз" in query_lower:
        return ("tz", "Создай Техническое Задание.")
    elif "руководство пользователя" in query_lower or "инструкция" in query_lower:
        return ("manual", "Создай Руководство пользователя.")
    else:
        return ("general", "Создай документ на основе запроса.")


def get_tz_sections() -> list[tuple[str, str]]:
    """Возвращает список разделов для Технического задания."""
    sections = [
        ("1. Общие положения", "описать общие положения, контекст, обозначения, сокращения, плановые сроки и порядок оформления и предъявления результатов работ"),
        ("2. Назначение и цели создания Системы", "описать назначение системы, цели создания, ожидаемые эффекты, измеримые показатели и задачи"),
        ("3. Характеристика объектов автоматизации", "описать профиль организации-заказчика, объекты автоматизации, материальные и информационные объекты"),
        ("4. Требования к Системе", "описать функциональные, нефункциональные, эксплуатационные, надежности, к интерфейсам, интеграциям и безопасности"),
        ("5. Состав и содержание работ по созданию Системы", "описать этапы и виды работ, что выполняется на каждом этапе жизненного цикла"),
        ("6. Порядок контроля и приемки Системы", "описать виды и этапы испытаний, критерии приемки, порядок оформления результатов"),
        ("7. Требования к подготовке объекта автоматизации к вводу Системы в действие", "описать действия и ответственность заказчика, какие условия должны быть выполнены к вводу системы"),
        ("8. Требования к документированию", "описать состав комплектов документации, виды документов и общие требования к ним"),
        ("9. Источники разработки", "описать перечень нормативных документов, исходных материалов и проектной документации, на основании которых ведется разработка"),
        ("10. Приложения", "описать, какие материалы и таблицы могут быть вынесены в приложения к ТЗ"),
    ]
    return sections


def get_manual_sections() -> list[tuple[str, str]]:
    """Возвращает список разделов для Руководства пользователя."""
    sections = [
        ("1. Введение", "кратко описать назначение системы для пользователя, целевую аудиторию руководства и общую структуру документа"),
        ("2. Назначение и область применения", "описать, для каких задач и в каких сценариях конечный пользователь использует систему"),
        ("3. Требования к рабочему месту и окружению", "описать минимальные требования к оборудованию, ПО, сетевой инфраструктуре, правам доступа"),
        ("4. Установка и запуск системы", "описать шаги по установке, первичной настройке и запуску клиентских компонентов/веб-интерфейса"),
        ("5. Обзор интерфейса и основных экранов", "описать основные разделы интерфейса, навигацию, ключевые элементы экранов"),
        ("6. Роли пользователей и их права", "описать типы пользователей (оператор, инженер, администратор и т.п.) и доступные им функции"),
        ("7. Типовые сценарии работы", "пошагово описать основные пользовательские сценарии: подготовка данных, запуск расчетов/моделирования, анализ результатов"),
        ("8. Работа с отчетами и результатами моделирования", "описать просмотр, экспорт и интерпретацию отчетов и визуализаций"),
        ("9. Обработка ошибок и нестандартных ситуаций", "описать типовые сообщения об ошибках, их причины и рекомендуемые действия пользователя"),
        ("10. Резервное копирование и восстановление пользовательских данных", "описать, что пользователь может/должен делать для сохранения и восстановления своих данных (если применимо)"),
        ("11. Приложения", "описать, какие дополнительные материалы, таблицы и словари терминов могут быть вынесены в приложения к руководству"),
    ]
    return sections


def is_question_like(query: str) -> bool:
    """Проверяет, является ли запрос вопросом."""
    q = query.strip().lower()
    if "?" in q:
        return True

    question_words = {
        "как",
        "что",
        "кто",
        "где",
        "когда",
        "зачем",
        "почему",
        "какие",
        "какая",
        "какой",
        "каково",
        "сколько",
    }

    tokens = q.split()
    if not tokens:
        return False

    # Прямой вопрос: начинается с вопросительного слова
    if tokens[0] in question_words:
        return True

    # Вариант вроде "Документ: Какие специалисты ..." или "Вопрос: Как ..."
    first = tokens[0].rstrip(":")
    if first in {"документ", "вопрос", "запрос"} and len(tokens) > 1 and tokens[1] in question_words:
        return True

    return False


def has_strong_doc_type_markers(query: str) -> bool:
    """Проверяет наличие маркеров типа документа в запросе."""
    q = query.lower()
    markers = (
        "техническое задание",
        "тз",
        "руководство пользователя",
        "инструкция",
    )
    return any(m in q for m in markers)


def read_template_file(template_name: str) -> str:
    """Читает файл шаблона (.docx) и возвращает его текстовое содержимое."""
    if not template_name:
        return ""
    
    template_path = os.path.join("templates", template_name)
    
    if not os.path.exists(template_path):
        print(f"Шаблон не найден: {template_path}")
        return ""
        
    try:
        doc = Document(template_path)
        full_text = "\n".join([para.text for para in doc.paragraphs])
        print(f"Шаблон '{template_name}' успешно прочитан. Длина текста: {len(full_text)} символов.")
        return full_text
    except Exception as e:
        print(f"ОШИБКА при чтении шаблона '{template_name}': {e}")
        return ""


