# main.py (ПОЛНАЯ ФИНАЛЬНАЯ ВЕРСИЯ)
from fastapi import FastAPI
from pydantic import BaseModel
import os
from dotenv import load_dotenv

from services.openai_service import generate_text, LLMError
from services.knowledge_service import KnowledgeService
from services.docx_service import create_docx

load_dotenv()

app = FastAPI(title="Smart Writer API")
ks = KnowledgeService()

class RequestModel(BaseModel):
    query: str

def classify_intent_and_structure(query: str) -> tuple[str, str]:
    """Определяет тип документа и возвращает его универсальную структуру."""
    query_lower = query.lower()
    
    if "техническое задание" in query_lower or "тз" in query_lower:
        return ("tz", """
        Структура Технического Задания (ТЗ):
        1. Введение
        2. Основные термины и определения (Глоссарий)
        3. Общие положения (Область применения, нормативные ссылки)
        4. Требования к системе:
           - Функциональные требования
           - Нефункциональные требования (Надёжность, Производительность, Совместимость)
           - Требования к данным
           - Требования к интерфейсу
        5. Архитектура системы
        6. Руководство пользователя (основные сценарии)
        7. Приложения (схемы, диаграммы)
        """)
    elif "руководство пользователя" in query_lower or "инструкция" in query_lower:
        return ("manual", """
        Структура Руководства пользователя:
        1. Введение
        2. Начало работы (установка, первый запуск)
        3. Основные функции (описание каждого модуля)
        4. Расширенные возможности
        5. Часто задаваемые вопросы (FAQ)
        6. Поддержка и контакты
        """)
    elif "описание" in query_lower or "обзор" in query_lower:
        return ("description", """
        Структура Описания системы:
        1. Обзор системы
        2. Назначение и цели создания
        3. Основные компоненты и модули
        4. Принципы работы
        5. Ключевые преимущества и отличия
        """)
    elif "регламент" in query_lower or "представление" in query_lower:
        return ("regulation", """
        Структура Регламента работы с системой:
        1. Общие положения
        2. Порядок работы с системой (для разных ролей)
        3. Ответственность сотрудников
        4. Контроль качества данных
        5. Порядок отчетности
        """)
    elif "функциональные требования" in query_lower or "фт" in query_lower:
        return ("functional_requirements", """
        Структура документа "Функциональные требования":
        1. Введение
        2. Общие положения
        3. Перечень функциональных требований
        4. Детализация требований по модулям
        5. Нефункциональные ограничения
        """)
    elif "регламент тестирования" in query_lower or "тест план" in query_lower:
        return ("test_plan", """
        Структура Регламента тестирования:
        1. Введение
        2. Объект и цели тестирования
        3. Тестовое окружение
        4. Тестовые сценарии
        5. Критерии успешности
        """)
    elif "бизнес-процесс" in query_lower or "процесс" in query_lower:
        return ("business_process", """
        Структура Описания бизнес-процесса:
        1. Название процесса
        2. Цель процесса
        3. Участники (роли)
        4. Входящие и исходящие данные
        5. Пошаговое описание процесса
        6. Показатели эффективности
        """)
    elif "проектный план" in query_lower or "роадмап" in query_lower or "roadmap" in query_lower:
        return ("project_plan", """
        Структура Проектного плана:
        1. Введение
        2. Цели и задачи проекта
        3. Этапы и сроки
        4. Ресурсы и бюджет
        5. Риски и способы их минимизации
        """)
    elif "анализ рисков" in query_lower or "риски" in query_lower:
        return ("risk_analysis", """
        Структура Анализа рисков:
        1. Введение
        2. Методология анализа
        3. Перечень идентифицированных рисков
        4. Оценка вероятности и воздействия
        5. План реагирования на риски
        """)
    elif "развертывание" in query_lower or "установка" in query_lower or "деплой" in query_lower:
        return ("deployment_guide", """
        Структура Руководства по развертыванию:
        1. Введение
        2. Системные требования
        3. Пошаговая инструкция по установке
        4. Первоначальная настройка
        5. Проверка работоспособности
        """)
    else:
        return ("general", "Ответь на вопрос на основе предоставленной информации.")

@app.get("/")
def read_root():
    return {"status": "Smart Writer API is running"}

@app.post("/generate")
def generate_documentation(request: RequestModel):
    user_query = request.query
    print(f"\n--- НОВЫЙ ЗАПРОС: {user_query} ---")
    
    try:
        # 1. Ищем релевантный контекст
        relevant_context = ks.search_relevant_knowledge(query=user_query, n_results=100)
        
        # 2. Определяем тип документа и структуру
        intent_type, structure_prompt = classify_intent_and_structure(user_query)
        print(f"Определен тип документа: {intent_type}")

        # 3. Формируем финальный промпт
        prompt = f"""
        Ты — старший технический писатель и бизнес-аналитик с многолетним опытом. Твоя задача — создать структурированный документ на основе запроса пользователя и предоставленной базы знаний.

        ЗАПРОС ПОЛЬЗОВАТЕЛЯ: "{user_query}"

        СТРУКТУРА ДОКУМЕНТА (ИСПОЛЬЗУЙ ИМЕННО ЭТУ СТРУКТУРУ):
        {structure_prompt}

        БАЗА ЗНАНИЙ (ИСПОЛЬЗУЙ ТОЛЬКО ЭТУ ИНФОРМАЦИЮ):
        ---
        {relevant_context}
        ---

        СТРОГИЕ ПРАВИЛА СОЗДАНИЯ ДОКУМЕНТА:
        1.  **Анализ и Синтез:** Твоя задача — не копировать, а анализировать и синтезировать информацию из БАЗЫ ЗНАНИЙ, чтобы логично заполнить каждый пункт СТРУКТУРЫ.
        2.  **ЗАПРЕТ НА ГАЛЛЮЦИНАЦИИ:** Если для какого-либо пункта СТРУКТУРЫ в БАЗЕ ЗНАНИЙ нет данных, НЕ ПРИДУМЫВАЙ ИХ. Вместо этого напиши: "Данные для этого раздела отсутствуют в предоставленных источниках".
        3.  **Точность:** Используй только факты из БАЗЫ ЗНАНИЙ. Не добавляй информацию, которая там не упоминается.
        4.  **Профессионализм:** Пиши на профессиональном русском языке, используя терминологию из БАЗЫ ЗНАНИЙ.
        5.  **Форматирование:** Оформи итоговый документ в формате Markdown. Используй заголовки (##, ###), списки (*), **жирный текст** для улучшения читаемости.

        Приступай к созданию документа, строго следуя правилам выше.
        """
        
        # 4. Генерируем текст
        generated_text = generate_text(prompt)
        
        # 5. Создаем DOCX файл
        title = f"Документ: {user_query}"
        docx_path = create_docx(content=generated_text, title=title)
        
        return {"status": "success", "file_path": docx_path}

    except LLMError as e:
        error_message = f"Не удалось сгенерировать текст. Причина: {e}"
        print(error_message)
        return {"status": "error", "message": error_message}
    except Exception as e:
        error_message = f"Произошла непредвиденная ошибка: {e}"
        print(error_message)
        return {"status": "error", "message": error_message}